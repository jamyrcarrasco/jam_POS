<div class="product-modal">
  <div mat-dialog-title class="modal-header">
    <h2>{{ data.isEdit ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="modal-content">
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" placeholder="Nombre del producto" required>
          <mat-error *ngIf="productForm.get('nombre')?.hasError('required')">
            El nombre es requerido
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción</mat-label>
          <textarea matInput formControlName="descripcion" placeholder="Descripción del producto" rows="3"></textarea>
        </mat-form-field>
      </div>

      <div class="form-row three-col">
        <mat-form-field appearance="outline">
          <mat-label>Precio</mat-label>
          <input matInput type="number" formControlName="precio" placeholder="0.00" required>
          <span matTextPrefix>$&nbsp;</span>
          <mat-error *ngIf="productForm.get('precio')?.hasError('min')">
            El precio debe ser mayor a 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Stock</mat-label>
          <input matInput type="number" formControlName="stock" placeholder="0" required>
          <mat-error *ngIf="productForm.get('stock')?.hasError('min')">
            El stock no puede ser negativo
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Stock Mínimo</mat-label>
          <input matInput type="number" formControlName="stockMinimo" placeholder="0">
        </mat-form-field>
      </div>

      <div class="form-row two-col">
        <mat-form-field appearance="outline">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="categoriaId">
            <mat-option [value]="null">Ninguna</mat-option>
            <mat-option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Código de Barras</mat-label>
          <input matInput formControlName="codigoBarras" placeholder="Código de barras">
        </mat-form-field>
      </div>

      <div class="form-row two-col">
        <mat-form-field appearance="outline">
          <mat-label>Precio de Compra</mat-label>
          <input matInput type="number" formControlName="precioCompra" placeholder="0.00">
          <span matTextPrefix>$&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Margen de Ganancia (%)</mat-label>
          <input matInput type="number" formControlName="margenGanancia" placeholder="0">
          <span matTextSuffix>%</span>
        </mat-form-field>
      </div>

      <mat-divider></mat-divider>

      <div class="form-row">
        <div class="full-width">
          <label class="form-label">Imagen del Producto</label>
          <app-image-upload 
            [control]="productForm.get('imagenUrl')!"
            folder="products"
            (imageUploaded)="onImageUploaded($event)"
            (imageRemoved)="onImageRemoved()">
          </app-image-upload>
        </div>
      </div>

      <div class="form-row">
        <mat-slide-toggle formControlName="activo" color="primary">
          Producto Activo
        </mat-slide-toggle>
      </div>
    </form>
  </div>

  <div mat-dialog-actions class="modal-actions">
    <button mat-button (click)="onCancel()" [disabled]="loading">
      Cancelar
    </button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="!productForm.valid || loading">
      <mat-icon *ngIf="loading" class="spinner-icon">refresh</mat-icon>
      <mat-icon *ngIf="!loading">{{ data.isEdit ? 'save' : 'add' }}</mat-icon>
      {{ data.isEdit ? 'Actualizar' : 'Crear' }} Producto
    </button>
  </div>
</div>
