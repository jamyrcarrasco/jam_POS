<div class="tax-container">
  <!-- Breadcrumbs -->
  <nav class="breadcrumbs">
    <a routerLink="/dashboard">Inicio</a>
    <span class="separator">/</span>
    <a routerLink="/configuraciones">Configuraciones</a>
    <span class="separator">/</span>
    <span class="current">Impuestos</span>
  </nav>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>Gestión de Impuestos</h1>
      <p class="subtitle">Configure los impuestos que se aplicarán a sus productos y ventas</p>
    </div>
    <button mat-raised-button color="primary" (click)="toggleForm()" class="add-button">
      <mat-icon>{{ showForm ? 'close' : 'add' }}</mat-icon>
      {{ showForm ? 'Cancelar' : 'Nuevo Impuesto' }}
    </button>
  </div>

  <!-- Form Card -->
  <mat-card class="form-card" *ngIf="showForm">
    <mat-card-header>
      <mat-card-title>{{ isEditing ? 'Editar Impuesto' : 'Crear Nuevo Impuesto' }}</mat-card-title>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content>
      <form [formGroup]="taxForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <!-- Nombre -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre del Impuesto</mat-label>
            <input matInput formControlName="nombre" placeholder="Ej: IVA, ITBIS, ISV">
            <mat-icon matPrefix>local_offer</mat-icon>
            <mat-error *ngIf="taxForm.get('nombre')?.hasError('required')">
              El nombre es requerido
            </mat-error>
          </mat-form-field>

          <!-- Descripción -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción (Opcional)</mat-label>
            <textarea matInput formControlName="descripcion" placeholder="Breve descripción del impuesto" rows="2"></textarea>
            <mat-icon matPrefix>description</mat-icon>
          </mat-form-field>

          <!-- Tipo -->
          <mat-form-field appearance="outline">
            <mat-label>Tipo de Impuesto</mat-label>
            <mat-select formControlName="tipo">
              <mat-option *ngFor="let tipo of tiposImpuesto" [value]="tipo.value">
                {{ tipo.label }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <!-- Porcentaje (solo si es PORCENTUAL) -->
          <mat-form-field appearance="outline" *ngIf="taxForm.get('tipo')?.value === 'PORCENTUAL'">
            <mat-label>Porcentaje</mat-label>
            <input matInput type="number" formControlName="porcentaje" placeholder="Ej: 18" min="0" max="100" step="0.01">
            <span matSuffix>%</span>
            <mat-error *ngIf="taxForm.get('porcentaje')?.hasError('min')">
              El porcentaje no puede ser negativo
            </mat-error>
            <mat-error *ngIf="taxForm.get('porcentaje')?.hasError('max')">
              El porcentaje no puede ser mayor a 100
            </mat-error>
          </mat-form-field>

          <!-- Monto Fijo (solo si es FIJO) -->
          <mat-form-field appearance="outline" *ngIf="taxForm.get('tipo')?.value === 'FIJO'">
            <mat-label>Monto Fijo</mat-label>
            <input matInput type="number" formControlName="montoFijo" placeholder="Ej: 1.50" min="0" step="0.01">
            <span matPrefix>$&nbsp;</span>
            <mat-error *ngIf="taxForm.get('montoFijo')?.hasError('min')">
              El monto no puede ser negativo
            </mat-error>
          </mat-form-field>

          <!-- Aplica por Defecto -->
          <div class="toggle-field">
            <mat-slide-toggle formControlName="aplicaPorDefecto" color="primary">
              Aplicar por defecto en ventas
            </mat-slide-toggle>
            <span class="toggle-hint">Si se activa, este impuesto se agregará automáticamente a nuevas ventas</span>
          </div>

          <!-- Activo -->
          <div class="toggle-field">
            <mat-slide-toggle formControlName="activo" color="primary">
              Impuesto Activo
            </mat-slide-toggle>
            <span class="toggle-hint">Solo los impuestos activos estarán disponibles para aplicar</span>
          </div>
        </div>

        <div class="form-actions">
          <button mat-button type="button" (click)="cancelEdit()" [disabled]="loading">
            Cancelar
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || taxForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            <span *ngIf="!loading">{{ isEditing ? 'Actualizar' : 'Crear' }}</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Table Card -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>receipt</mat-icon>
        Lista de Impuestos
      </mat-card-title>
      <span class="spacer"></span>
      <span class="total-count">Total: {{ taxes.length }}</span>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="taxes" class="tax-table">
          
          <!-- Nombre Column -->
          <ng-container matColumnDef="nombre">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let tax">
              <div class="nombre-cell">
                <strong>{{ tax.nombre }}</strong>
                <small *ngIf="tax.descripcion">{{ tax.descripcion }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Tipo Column -->
          <ng-container matColumnDef="tipo">
            <th mat-header-cell *matHeaderCellDef>Tipo</th>
            <td mat-cell *matCellDef="let tax">
              <mat-chip [class.chip-porcentual]="tax.tipo === 'PORCENTUAL'" 
                        [class.chip-fijo]="tax.tipo === 'FIJO'">
                {{ tax.tipo === 'PORCENTUAL' ? 'Porcentual' : 'Monto Fijo' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Valor Column -->
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef>Valor</th>
            <td mat-cell *matCellDef="let tax">
              <span class="valor-display">{{ getValorDisplay(tax) }}</span>
            </td>
          </ng-container>

          <!-- Por Defecto Column -->
          <ng-container matColumnDef="defecto">
            <th mat-header-cell *matHeaderCellDef>Por Defecto</th>
            <td mat-cell *matCellDef="let tax">
              <mat-icon *ngIf="tax.aplicaPorDefecto" class="icon-check" matTooltip="Se aplica por defecto">
                check_circle
              </mat-icon>
              <mat-icon *ngIf="!tax.aplicaPorDefecto" class="icon-disabled" matTooltip="No se aplica por defecto">
                cancel
              </mat-icon>
            </td>
          </ng-container>

          <!-- Activo Column -->
          <ng-container matColumnDef="activo">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let tax">
              <mat-chip [class.chip-activo]="tax.activo" [class.chip-inactivo]="!tax.activo">
                {{ tax.activo ? 'Activo' : 'Inactivo' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let tax">
              <button mat-icon-button color="primary" (click)="editTax(tax)" matTooltip="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteTax(tax.id, tax.nombre)" matTooltip="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <!-- Empty State -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" colspan="6">
              <div class="empty-state">
                <mat-icon>receipt_long</mat-icon>
                <p>No hay impuestos registrados</p>
                <button mat-raised-button color="primary" (click)="toggleForm()">
                  <mat-icon>add</mat-icon>
                  Crear Primer Impuesto
                </button>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <div *ngIf="loading" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    </mat-card-content>
  </mat-card>
</div>

