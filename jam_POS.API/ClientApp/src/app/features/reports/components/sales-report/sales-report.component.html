<div class="sales-report-container">
  <!-- Breadcrumbs -->
  <nav class="breadcrumb-nav" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a [routerLink]="['/dashboard']">
          <mat-icon>home</mat-icon>
          Inicio
        </a>
      </li>
      <li class="breadcrumb-item active">
        <span>Reportes</span>
      </li>
    </ol>
  </nav>

  <div class="page-header">
    <div>
      <h1>Reporte de Ventas</h1>
      <p>Analiza el desempeño de tus ventas filtrando por periodo, producto y categoría.</p>
    </div>
  </div>

  <mat-card class="filters-card">
    <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filters-form">
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Tipo de período</mat-label>
          <mat-select formControlName="filterType">
            <mat-option value="month">Por mes</mat-option>
            <mat-option value="year">Por año</mat-option>
            <mat-option value="range">Rango de fechas</mat-option>
          </mat-select>
        </mat-form-field>

        <ng-container [ngSwitch]="filterForm.get('filterType')?.value">
          <ng-container *ngSwitchCase="'month'">
            <mat-form-field appearance="outline">
              <mat-label>Mes</mat-label>
              <mat-select formControlName="month">
                <mat-option *ngFor="let month of months" [value]="month.value">
                  {{ month.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="filterForm.get('month')?.hasError('required')">Selecciona un mes</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Año</mat-label>
              <mat-select formControlName="year">
                <mat-option *ngFor="let year of years" [value]="year">
                  {{ year }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="filterForm.get('year')?.hasError('required')">Selecciona un año</mat-error>
            </mat-form-field>
          </ng-container>

          <ng-container *ngSwitchCase="'year'">
            <mat-form-field appearance="outline">
              <mat-label>Año</mat-label>
              <mat-select formControlName="year">
                <mat-option *ngFor="let year of years" [value]="year">
                  {{ year }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="filterForm.get('year')?.hasError('required')">Selecciona un año</mat-error>
            </mat-form-field>
          </ng-container>

          <ng-container *ngSwitchCase="'range'">
            <mat-form-field appearance="outline">
              <mat-label>Desde</mat-label>
              <input
                matInput
                [matDatepicker]="startPicker"
                formControlName="startDate"
                placeholder="Fecha de inicio">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
              <mat-error *ngIf="filterForm.get('startDate')?.hasError('required')">La fecha de inicio es obligatoria</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Hasta</mat-label>
              <input
                matInput
                [matDatepicker]="endPicker"
                formControlName="endDate"
                placeholder="Fecha final">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </ng-container>
        </ng-container>

        <mat-form-field appearance="outline">
          <mat-label>Producto</mat-label>
          <mat-select formControlName="productId">
            <mat-option [value]="null">Todos los productos</mat-option>
            <mat-option *ngFor="let product of products; trackBy: trackById" [value]="product.id">
              {{ product.nombre }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="categoryId">
            <mat-option [value]="null">Todas las categorías</mat-option>
            <mat-option *ngFor="let category of categories; trackBy: trackById" [value]="category.id">
              {{ category.nombre }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filters-actions">
        <button mat-stroked-button type="button" (click)="clearFilters()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Limpiar filtros
        </button>
        <button mat-flat-button color="primary" type="submit" [disabled]="loading">
          <mat-icon>filter_alt</mat-icon>
          Aplicar filtros
        </button>
      </div>
    </form>

    <div class="active-filters" *ngIf="report">
      <mat-chip-set>
        <mat-chip class="period-chip">
          <mat-icon matChipAvatar>event</mat-icon>
          {{ currentFilterDescription }}
        </mat-chip>
        <mat-chip *ngIf="selectedProductName" matTooltip="Producto filtrado">
          <mat-icon matChipAvatar>inventory_2</mat-icon>
          {{ selectedProductName }}
        </mat-chip>
        <mat-chip *ngIf="selectedCategoryName" matTooltip="Categoría filtrada">
          <mat-icon matChipAvatar>category</mat-icon>
          {{ selectedCategoryName }}
        </mat-chip>
      </mat-chip-set>
    </div>
  </mat-card>

  <div class="loading-state" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
    <p>Cargando reporte de ventas...</p>
  </div>

  <ng-container *ngIf="!loading">
    <ng-container *ngIf="report; else noDataTemplate">
      <div class="summary-grid">
        <mat-card class="summary-card primary">
          <mat-icon class="summary-icon">attach_money</mat-icon>
          <div>
            <h3>Total vendido</h3>
            <p>{{ report?.totalVentas | currency:'DOP':'symbol':'1.2-2' }}</p>
          </div>
        </mat-card>

        <mat-card class="summary-card accent">
          <mat-icon class="summary-icon">receipt_long</mat-icon>
          <div>
            <h3>Ventas registradas</h3>
            <p>{{ report?.cantidadVentas }}</p>
          </div>
        </mat-card>

        <mat-card class="summary-card warn">
          <mat-icon class="summary-icon">shopping_cart</mat-icon>
          <div>
            <h3>Artículos vendidos</h3>
            <p>{{ report?.totalItemsVendidos | number:'1.0-2' }}</p>
          </div>
        </mat-card>

        <mat-card class="summary-card neutral">
          <mat-icon class="summary-icon">equalizer</mat-icon>
          <div>
            <h3>Promedio por venta</h3>
            <p>{{ report?.promedioVenta | currency:'DOP':'symbol':'1.2-2' }}</p>
          </div>
        </mat-card>
      </div>

      <mat-card class="ventas-card">
        <mat-card-header>
          <mat-card-title>Detalle de ventas</mat-card-title>
          <mat-card-subtitle *ngIf="report?.cantidadVentas && report.cantidadVentas > 0">
            {{ report?.cantidadVentas }} venta(s) encontradas
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="report?.ventas || []" class="mat-elevation-z1" *ngIf="report?.ventas?.length; else noSales">
            <ng-container matColumnDef="numeroVenta">
              <th mat-header-cell *matHeaderCellDef>Número</th>
              <td mat-cell *matCellDef="let venta">{{ venta.numeroVenta }}</td>
            </ng-container>

            <ng-container matColumnDef="fechaVenta">
              <th mat-header-cell *matHeaderCellDef>Fecha</th>
              <td mat-cell *matCellDef="let venta">{{ venta.fechaVenta | date:'dd/MM/yyyy' }}</td>
            </ng-container>

            <ng-container matColumnDef="usuarioNombre">
              <th mat-header-cell *matHeaderCellDef>Registrado por</th>
              <td mat-cell *matCellDef="let venta">{{ venta.usuarioNombre || 'N/D' }}</td>
            </ng-container>

            <ng-container matColumnDef="cantidadItems">
              <th mat-header-cell *matHeaderCellDef>Artículos</th>
              <td mat-cell *matCellDef="let venta">{{ venta.cantidadItems | number:'1.0-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="subtotal">
              <th mat-header-cell *matHeaderCellDef>Subtotal</th>
              <td mat-cell *matCellDef="let venta">{{ venta.subtotal | currency:'DOP':'symbol':'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="totalImpuestos">
              <th mat-header-cell *matHeaderCellDef>Impuestos</th>
              <td mat-cell *matCellDef="let venta">{{ venta.totalImpuestos | currency:'DOP':'symbol':'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="totalDescuentos">
              <th mat-header-cell *matHeaderCellDef>Descuentos</th>
              <td mat-cell *matCellDef="let venta">{{ venta.totalDescuentos | currency:'DOP':'symbol':'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let venta">{{ venta.total | currency:'DOP':'symbol':'1.2-2' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedSalesColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedSalesColumns;"></tr>
          </table>

          <ng-template #noSales>
            <div class="empty-state">
              <mat-icon>receipt_long</mat-icon>
              <p>No se encontraron ventas para los filtros seleccionados.</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card class="productos-card">
        <mat-card-header>
          <mat-card-title>Productos vendidos</mat-card-title>
          <mat-card-subtitle *ngIf="report?.productos?.length">
            Ordenados por monto total vendido
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="report?.productos || []" class="mat-elevation-z1" *ngIf="report?.productos?.length; else noProducts">
            <ng-container matColumnDef="productoNombre">
              <th mat-header-cell *matHeaderCellDef>Producto</th>
              <td mat-cell *matCellDef="let producto">{{ producto.productoNombre }}</td>
            </ng-container>

            <ng-container matColumnDef="categoriaNombre">
              <th mat-header-cell *matHeaderCellDef>Categoría</th>
              <td mat-cell *matCellDef="let producto">{{ producto.categoriaNombre || 'Sin categoría' }}</td>
            </ng-container>

            <ng-container matColumnDef="cantidadVendida">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let producto">{{ producto.cantidadVendida | number:'1.0-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="totalVendido">
              <th mat-header-cell *matHeaderCellDef>Total vendido</th>
              <td mat-cell *matCellDef="let producto">{{ producto.totalVendido | currency:'DOP':'symbol':'1.2-2' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedProductColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedProductColumns;"></tr>
          </table>

          <ng-template #noProducts>
            <div class="empty-state">
              <mat-icon>inventory_2</mat-icon>
              <p>No hay productos registrados en este periodo.</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </ng-container>

  <ng-template #noDataTemplate>
    <div class="empty-state" *ngIf="!errorMessage">
      <mat-icon>bar_chart</mat-icon>
      <p>Configura los filtros y selecciona “Aplicar” para ver tu reporte de ventas.</p>
    </div>
    <div class="empty-state error" *ngIf="errorMessage">
      <mat-icon>error_outline</mat-icon>
      <p>{{ errorMessage }}</p>
    </div>
  </ng-template>
</div>
